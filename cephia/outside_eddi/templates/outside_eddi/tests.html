{% extends 'outside_eddi/base.html' %}
{% load bootstrap3 %}
{% load js_reverse %}
{% load test_id %}

{% block extrajs%}
  <script src="http://malsup.github.com/jquery.form.js"></script>
  <script src="{% url 'js_reverse' %}" type="text/javascript"></script>
{% endblock %}

{% block content %}
  <div class="container">

    <h4>Your tests</h4>
    <form name="tests"  method="post" id="form" enctype="multipart/form-data">{% csrf_token %}
      <table class="table table-condensed table-striped">
        <thead>
          <tr>
            <th>Tests</th>
            <th>Details</th>
            <th>Properties</th>
          </tr>
        </thead>
        <tbody>

          {{ user_formset.management_form }}
          {% for form in user_formset %}
            <tr>
              <td>
                {% bootstrap_field form.name show_label=False %} {{ form.id }}
              </td>
              <td>
                {% bootstrap_field form.description show_label=False %}
              </td>
              <td>
                <a class="btn btn-primary js-show-user-properties" name="{{ form.name.html_name }}" id="{{ form.description.html_name }}" data-toggle="modal" data-target="#modal" href="{% url 'outside_eddi:test_properties' 'user' 'None' 1 'None' %}">Properties</a>
              </td>
            </tr>
          {% endfor %}

        </tbody>
      </table>
      <button class="btn btn-primary pull-right">Save</button>
    </form>

    <h4>Global tests</h4>
    <form name="tests"  method="post" id="form" enctype="multipart/form-data">{% csrf_token %}
      <table class="table table-condensed table-striped">
        <thead>
          <tr>
            <th>Tests</th>
            <th>Details</th>
            <th>Properties</th>
          </tr>
        </thead>
        <tbody>

          {{ global_formset.management_form }}
          {% for form in global_formset %}
            <tr>
              <td>
                {% bootstrap_field form.name show_label=False %} {{ form.id }}
              </td>
              <td>
                {% bootstrap_field form.description show_label=False %}
              </td>
              <td>
                <a class="btn btn-primary js-show-global-properties" name="{{ form.name.html_name }}" id="{{ form.description.html_name }}" data-toggle="modal" data-target="#modal" href="{% url 'outside_eddi:test_properties' 'global' 'None' 1 'None' %}">Properties</a>
              </td>
            </tr>
          {% endfor %}

        </tbody>
      </table>
    </form>

    <div class="modal fade" id="modal"></div>
    <script>
     $('.js-show-user-properties').click(function(event) {
         event.preventDefault();
         url = $(this).attr('href');

         test_field = $(this).attr('name');
         details_field = $(this).attr('id');
         /* var test_name = $("#id_" + test_field).attr("value");*/
         var test_name = $("#id_" + test_field).val();
         var details = $("#id_" + details_field).val();
         var file_id = 'None';
         if (!test_name){
             alert('Please insert a test name')
             $(this).attr('data-toggle', '')
         }
         else {
             var tests_by_name = {{ test_ids_by_name|safe }}
             var test = tests_by_name[test_name]
             var code = 'user'
             if (!test){
                 var test = test_name.split(' ').join('___');
                 var code = 'new_user_test';
             }
             if (!details){
                 var details = 'no_user_details';
             }

             details = details.split(' ').join('___');
             url = Urls["outside_eddi:test_properties"](code, details, test, file_id)

             $.get(url).done(function(html) {
                 $('#modal').html(html);
                 $('#modal').modal();
             });
         }
     });

     $('.js-show-global-properties').click(function(event) {
         event.preventDefault();
         url = $(this).attr('href');

         test_field = $(this).attr('name');
         /* var test_name = $("#id_" + test_field).attr("value");*/
         var test_name = $("#id_" + test_field).val();
         var tests_by_name = {{ test_ids_by_name|safe }}
         var test = tests_by_name[test_name]
         var code = 'global'
         var details = 'None';
         var file_id = 'None';

         url = Urls["outside_eddi:test_properties"](code, details, test, file_id)

         $.get(url).done(function(html) {
             $('#modal').html(html);
             $('#modal').modal();
         });
     });

     $('#modal').on("click", '.js-submit-properties', function(event) {
         event.preventDefault();

         var form = $(this).parents('form');
         post_data = form.serialize();
         $.post(form.attr('action'), post_data).done(function(resp) {
             if (resp.success) {
                 $('#modal').modal('hide');
                 location.reload();
             } else {
                 $('#modal').html(resp);
             }
         });
     });

     $('#modal').on("click", '.js-close-properties', function(event) {
         event.preventDefault();
         $('#modal').modal('hide');
         location.reload();
     });
    </script>
    
  </div>
{% endblock %}
