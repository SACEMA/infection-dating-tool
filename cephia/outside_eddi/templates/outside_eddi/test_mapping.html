{% extends 'outside_eddi/base.html' %}
{% load bootstrap3 %}
{% load js_reverse %}
{% load test_details %}

{% block extrajs%}
  <script src="http://malsup.github.com/jquery.form.js"></script>
  <script src="{% url 'js_reverse' %}" type="text/javascript"></script>
{% endblock %}

{% block content %}
  <div class="container">

    {% if file %}
      <h3>Mapping for {{ file.filename }}</h3>

      <form name="file_mapping"  method="post" id="form" enctype="multipart/form-data">{% csrf_token %}
        <table class="table table-condensed table-striped">
          <thead>
            <tr>
              <th>Code</th>
              <th>Test</th>
              <th>Property</th>
            </tr>
          </thead>
          <tbody>
            
            {{ data_file_formset.management_form }}
            {% for form in data_file_formset %}
              <tr>
                <td>
                  {% bootstrap_field form.code show_label=False %} {{ form.id }}
                </td>
                <td class="js-show-test-details" name="{{ form.test.html_name }}" title="">
                  {% bootstrap_field form.test show_label=False %}
                </td>
                <td>
                  <a class="btn btn-primary js-show-properties" data-test-id="{{ form.instance.test.pk }}" data-map-id="{{ form.instance.pk }}" data-toggle="modal" data-target="#modal" href="#">Properties</a>
                </td>
              </tr>
            {% endfor %}
            
          </tbody>
        </table>
      </form>

      <h3>All Your Mapping</h3>
    {% endif %}

    <button class="js-add-mapping btn btn-default">Add a new mapping</button>
    
    <form name="mapping"  method="post" id="form" enctype="multipart/form-data">{% csrf_token %}
      <table class="table table-condensed table-striped">
        <thead>
          <tr>
            <th>Code</th>
            <th>Test</th>
            <th>Property</th>
          </tr>
        </thead>
        <tbody>
          
          {{ formset.management_form }}
          {% for form in formset %}
            <tr>
              <td>
                {% bootstrap_field form.code show_label=False %} {{ form.id }}
              </td>
              <td class="js-show-test-details" name="{{ form.test.html_name }}" title="">
                {% bootstrap_field form.test show_label=False %}
              </td>
              <td>
                <a class="btn btn-primary js-show-properties" data-test-id="{{ form.instance.test.pk }}" data-map-id="{{ form.instance.pk }}" data-toggle="modal" data-target="" href="#">Properties</a>
              </td>
            </tr>
          {% endfor %}
          
        </tbody>
      </table>
    </form>

    

    <div class="modal fade" id="modal-add-mapping">
      {% include 'outside_eddi/create_mapping_form.html' %}
    </div>

    <div class="modal fade" id="modal"></div>
    
    <script>
     $('.js-add-mapping').click(function() {
         $('#modal-add-mapping').modal()
     })

     $('#modal-add-mapping').on('click', '.js-confirm-add-mapping', function(event) {
         event.preventDefault();
         var form = $('#modal-add-mapping').find('form');
         post_data = form.serialize();
         var that = this;
         $.post(form.attr('action'), post_data).done(function(resp) {
             if (resp.redirect_url) {
                 location.href = resp.redirect_url
             } else {
                 $('#modal-add-mapping').html(resp)
             }
         })
     })
     
     $('.js-show-properties').click(function(event) {
         event.preventDefault();

         // submit form
         var form = $(this).parents('form');
         post_data = form.serialize();
         var that = this;
         $.post(form.attr('action'), post_data).done(function(resp) {
             if (resp.success) {

                 var url;
                 //  look up data attributes html
                 var test_id = $(that).data('test-id');
                 var map_id = $(that).data('map-id');
                 var file_id = "{{ file.pk }}" || undefined;

                 if (!map_id){
                     alert('Please insert a code')
                     $(this).attr('data-toggle', '')
                 }
                 else if (!test_id){
                     alert('Please select a test')
                     $(this).attr('data-toggle', '')
                 }
                 
                 if (file_id) {
                     url = Urls["outside_eddi:test_properties"](map_id, file_id)
                 } else {
                     url = Urls["outside_eddi:test_properties"](map_id)
                     alert(url)
                 }

                 $.get(url).done(function(html) {
                     $('#modal').html(html);
                     $('#modal').modal();
                 });

             } else {
                 $(this).attr('data-toggle', '')
                 alert(resp.error)
             }
         });
     });

     $('#modal').on("click", '.js-submit-properties', function(event) {
         event.preventDefault();

         var form = $(this).parents('form');
         post_data = form.serialize();
         $.post(form.attr('action'), post_data).done(function(resp) {
             if (resp.success) {
                 $('#modal').modal('hide');
                 location.reload();
             } else {
                 $('#modal').html(resp);
             }
         });
     });

     $('#modal').on("click", '.js-close-properties', function(event) {
         event.preventDefault();
         $('#modal').modal('hide');
         location.reload();
     });

     $('.js-show-test-details').find('select').hover(function(event) {
         event.preventDefault();
         test_id = $(this).attr('name');
         var test = $("#id_" + test_id).find('option:selected').attr("value");
         var tooltips_for_tests = {{tooltips_for_tests|safe}};
         var tooltip = tooltips_for_tests[test];


         $(this).attr('title', tooltip)
     });

    </script>

  </div>
{% endblock %}
