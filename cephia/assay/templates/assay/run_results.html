{% extends "cephia/base.html" %}
{% load bootstrap3 %}
{% load el_pagination_tags %}

{% block filter_col_a %}
  {% bootstrap_field filter_form.specimen_label %}
{% endblock %}

{% block page_content %}

  {% paginate run_results %}
  <div class="container">
    
    <div class="row">

      <div class="panel panel-default" style="box-shadow: 10px 10px 5px #888888;">
        <div class="panel-heading">
          <h3 class="panel-title">Run({{run.run_date}}) - {{run_results.0.assay.name}} - {{run_results.0.panel.name}}</h3>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="container"

              <div class="row">
                <div class="btn-group">
                  <a href="{% url 'assay:detailed_run_results' run_id=run.id %}" target="_blank" class="btn btn-default" style="text-decoration:none;">Preview Detailed Results</a>
                </div>
                <div class="btn-group">
                  <a href="{% url 'assay:run_results' run_id=run.id %}?csv=1&detail=1" name="generic" class="btn btn-primary" style="text-decoration:none;">Export Detailed Results (long)</a>
                </div>
                <div class="btn-group">
                  <a href="{% url 'assay:run_results' run_id=run.id %}?csv=1&specific=1" name="specific" class="btn btn-danger" style="text-decoration:none;">Export Assay-specific Results (wide)</a>
                </div>
                <div class="btn-group">
                  <a href="{% url 'assay:run_results' run_id=run.id %}?csv=1&generic=1" name="generic" class="btn btn-success" style="text-decoration:none;">Export Generic Results</a>
                </div>
                {% show_pages %}
              </div>

              <div class="row">
                <div class="col-md-12">
                  {% if run.contains_all_panel_visits %}
                    <strong class="text-success">Contains all panel visits</strong>
                  {% else %}
                    <br>
                    <div class="panel panel-success">
                      <div class="panel-heading">
                        <h3 class="panel-title">
                          <a data-toggle="collapse" href="#panel_missing">Panel visits missing: </a>
                        </h3>
                      </div>
                      <div id="panel_missing" class="panel-collapse collapse">
                        <div class="panel-body">
                          {% include 'assay/_visit_table.html' with visits=run.visits_missing_from_panel.all %}
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>

                <div class="col-md-12">
                  {% if run.contains_visits_not_in_panel %}
                    <div class="panel panel-success">
                      <div class="panel-heading">
                        <h3 class="panel-title">
                          <a data-toggle="collapse" href="#panel_extra">Run contains extra visits:</a>
                        </h3>
                      </div>
                      <div id="panel_extra" class="panel-collapse collapse">
                        <div class="panel-body">
                          {% include 'assay/_visit_table.html' with visits=run.visits_not_in_panel.all %}
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>

                <div class="col-md-12">
                  {% if not run.has_expected_num_replicates %}
                    <strong class="text-danger">Inconsistent number of replicates found:</strong>

                    <table class="table table-condensed">
                      <thead>
                        <th>Panel Membership ID</th>
                        <th>Visit ID</th>
                        <th>Subject Label</th>
                        <th>Visit Date</th>
                        <th>Replicate count</th>
                      </thead>
                      {% for pm in run.inconsistent_replicates.all %}
                        <tr>
                          <td>{{ pm.pk }}</td>
                          <td><a href='{% url 'visits' pm.visit.pk %}'>{{ pm.visit.pk }}</a></td>
                          <td>{{ pm.visit.subject.subject_label }}</td>
                          <td>{{ pm.visit.visit_date }}</td>
                          <td>{{ pm.replicates }}</td>
                        </tr>
                      {% endfor %}

                    </table>

                  {% endif %}
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table-striped table table-hover" style="overflow:auto;">
                  <thead>
                    <th>Specimen Label</th>
                    <th>Days from EDDI</th>
                    <th>Days from LP DDI</th>
                    <th>VL</th>
                    <th>Subject Country</th>
                    <th>Subtype</th>
                    <th>ART Naive</th>
                    <th>On ART</th>
                    <th>Test Date</th>
                    <th>Result</th>
                    <th>Method</th>
                    <th>Warning Message</th>
                  </thead>
                  <tbody>
                    {% for result in run_results %}
                      <tr>
                        <td data-result-id="{{result.id}}" ><a class="view-specific-results">{{result.specimen.specimen_label}}</a></td>
                        <td>{{result.specimen.visit.visit_eddi.days_since_eddi}}</td>
                        <td>{{result.specimen.visit.visit_eddi.days_since_lp_ddi}}</td>
                        <td>{{result.specimen.visit.vl}}</td>
                        <td>{{result.specimen.subject.country.code}}</td>
                        <td>{{result.specimen.subject.subtype.name}}</td>
                        <td>{% if result.specimen.visit.treatment_naive %}{% bootstrap_icon "ok" %}{% else %}{% bootstrap_icon "remove" %}{% endif %}</td>
                        <td>{% if result.specimen.visit.on_treatment %}{% bootstrap_icon "ok" %}{% else %}{% bootstrap_icon "remove" %}{% endif %}</td>
                        <td>{{result.test_date}}</td>
                        <td>{{result.result}}</td>
                        <td>{{result.method}}</td>
                        <td>{{result.warning_msg}}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="result-modal-container">
    </div>
{% endblock %}
